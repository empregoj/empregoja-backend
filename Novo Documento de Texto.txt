const express = require('express');
const cors = require('cors');
const multer = require('multer');
const OpenAI = require('openai');
const sgMail = require('@sendgrid/mail');
require('dotenv').config();

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

app.use(cors());
app.use(express.json());

sgMail.setApiKey(process.env.SENDGRID_API_KEY);
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

const analisarCurriculo = async (imagemBase64) => {
    try {
        const response = await openai.chat.completions.create({
            model: "gpt-4o",
            messages: [
                {
                    role: "user",
                    content: [
                        {
                            type: "text",
                            text: `Analise esta imagem de curr√≠culo de um jovem angolano.
                            1. Identifique a √°rea profissional.
                            2. Sugira melhorias no curr√≠culo.
                            3. Escreva um resumo profissional persuasivo.
                            4. Sugira palavras-chave para LinkedIn.
                            5. Recomende forma√ß√µes ou cursos curtos.
                            Retorne em JSON.`
                        },
                        {
                            type: "image_url",
                            image_url: {
                                url: `data:image/jpeg;base64,${imagemBase64}`
                            }
                        }
                    ]
                }
            ]
        });

        return JSON.parse(response.choices[0].message.content);
    } catch (error) {
        return {
            area: "N√£o identificada",
            melhorias: ["Tente tirar outra foto mais n√≠tida"],
            resumo: "Curr√≠culo em an√°lise",
            palavras_chave: ["emprego", "jovem"],
            cursos: ["Procure cursos na sua √°rea"]
        };
    }
};

const enviarEmail = async (para, assunto, texto, html) => {
    const msg = {
        to: para,
        from: 'suporte.empregoja@gmail.com',
        subject: assunto,
        text: texto,
        html: html,
    };

    try {
        await sgMail.send(msg);
        console.log('Email enviado para:', para);
        return true;
    } catch (error) {
        console.error('Erro email:', error);
        return false;
    }
};

app.post('/analisar', upload.single('foto'), async (req, res) => {
    try {
        const imagemBase64 = req.file.buffer.toString('base64');
        const email = req.body.email;

        const resultado = await analisarCurriculo(imagemBase64);

        if (email) {
            await enviarEmail(
                email,
                '‚úÖ IA analisou teu curr√≠culo!',
                `Ol√°! A IA terminou a an√°lise. √Årea: ${resultado.area}`,
                `<h2>An√°lise do teu Curr√≠culo</h2>
                 <p><strong>√Årea:</strong> ${resultado.area}</p>
                 <p><strong>Resumo sugerido:</strong> ${resultado.resumo}</p>
                 <p><strong>Melhorias:</strong> ${resultado.melhorias.join(', ')}</p>
                 <p><strong>Palavras-chave:</strong> ${resultado.palavras_chave.join(', ')}</p>`
            );
        }

        res.json({
            sucesso: true,
            area: resultado.area,
            resumo: resultado.resumo,
            melhorias: resultado.melhorias,
            palavras_chave: resultado.palavras_chave,
            cursos: resultado.cursos
        });

    } catch (error) {
        res.status(500).json({ sucesso: false, erro: error.message });
    }
});

app.post('/registar', async (req, res) => {
    const { nome, email, telefone } = req.body;

    await enviarEmail(
        email,
        'üéâ Bem-vindo ao Emprego J√°!',
        `Ol√° ${nome}, tua conta foi criada com sucesso.`,
        `<h1>Ol√° ${nome}!</h1><p>Tua conta foi criada com sucesso.</p>`
    );

    res.json({ sucesso: true });
});

app.post('/ajuda', async (req, res) => {
    const { email, duvida } = req.body;

    await enviarEmail(
        'suporte.empregoja@gmail.com',
        'Nova d√∫vida',
        `Email: ${email}\nD√∫vida: ${duvida}`,
        `<p><strong>Email:</strong> ${email}</p><p><strong>D√∫vida:</strong> ${duvida}</p>`
    );

    await enviarEmail(
        email,
        'Recebemos tua d√∫vida',
        'Ol√°! Recebemos tua mensagem. Responderemos em breve.',
        '<p>Recebemos tua mensagem. Responderemos em breve.</p>'
    );

    res.json({ sucesso: true });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`üöÄ Servidor rodando na porta ${PORT}`);
});